<script>
// Injected from Netlify during build
const cloudName = window.CLOUDINARY_CLOUD_NAME;
const listTag = "ultragc_gallery"; // tag used in uploads

async function fetchList(){
  const url = `https://res.cloudinary.com/${cloudName}/image/list/${listTag}.json?_=${Date.now()}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('No list or Cloudinary blocked the request');
    const data = await res.json();
    renderGrid(data.resources || []);
  }catch(err){
    document.getElementById('msg').textContent = 'Unable to load gallery list. Upload some items or check tag.';
    console.error(err);
  }
}

function renderGrid(resources){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  if(!resources.length){ grid.innerHTML = '<p>No items found.</p>'; return; }

  resources.forEach(r => {
    const base = `https://res.cloudinary.com/${cloudName}/`;
    const isVideo = (r.format==='mp4' || r.format==='webm');
    const url = `${base}${isVideo ? 'video' : 'image'}/upload/${r.public_id}.${r.format}`;

    const caption = (r.context?.custom?.caption) || '';
    const category = (r.context?.custom?.category) || '';

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      ${isVideo ? `<video src="${url}" controls></video>` : `<img src="${url}">`}
      <div style="margin-top:8px;font-weight:700">${escapeHtml(caption)}</div>
      <div class="muted">${escapeHtml(category)}</div>

      <label style="margin-top:8px;font-weight:700">Edit caption</label>
      <input class="input" data-id="${r.public_id}" value="${escapeHtmlAttr(caption)}" type="text" />

      <label style="margin-top:8px;font-weight:700">Change category</label>
      <select class="input" data-id-cat="${r.public_id}">
        <option value="">-- select --</option>
        <option value="outreach"${category==='outreach'?' selected':''}>Outreach</option>
        <option value="widows"${category==='widows'?' selected':''}>Widows</option>
        <option value="orphans"${category==='orphans'?' selected':''}>Orphans</option>
        <option value="events"${category==='events'?' selected':''}>Events</option>
        <option value="scholarships"${category==='scholarships'?' selected':''}>Scholarships</option>
      </select>

      <button class="btn" data-save="${r.public_id}">Save</button>
      <button class="btn del" data-del="${r.public_id}">Delete</button>
    `;
    grid.appendChild(card);
  });

  document.querySelectorAll('[data-save]').forEach(btn=> btn.onclick = saveHandler);
  document.querySelectorAll('[data-del]').forEach(btn=> btn.onclick = delHandler);
}

function escapeHtml(s){ 
  if(!s) return ''; 
  return String(s).replace(/&/g,'&amp;')
                  .replace(/</g,'&lt;')
                  .replace(/>/g,'&gt;'); 
}
function escapeHtmlAttr(s){ 
  return (s||'').replace(/"/g,'&quot;')
                .replace(/'/g,"&#39;"); 
}

async function saveHandler(e){
  const id = e.currentTarget.getAttribute('data-save');
  const caption = document.querySelector(`input[data-id="${id}"]`).value.trim();
  const category = document.querySelector(`select[data-id-cat="${id}"]`).value;

  document.getElementById('msg').textContent = 'Saving...';

  try{
    const res = await fetch('/.netlify/functions/update-metadata', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ public_id: id, caption, category })
    });

    const j = await res.json();
    if(res.ok){
      document.getElementById('msg').textContent = 'Saved successfully';
      fetchList();
    } else {
      document.getElementById('msg').textContent = 'Save failed: ' + (j.error || res.statusText);
    }
  }catch(err){
    document.getElementById('msg').textContent = 'Save failed (check console)';
    console.error(err);
  }
}

async function delHandler(e){
  const id = e.currentTarget.getAttribute('data-del');
  if(!confirm('Delete this file?')) return;

  document.getElementById('msg').textContent = 'Deleting...';

  try{
    const res = await fetch('/.netlify/functions/delete-resource', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ public_id: id })
    });

    const j = await res.json();
    if(res.ok){
      document.getElementById('msg').textContent = 'Deleted';
      fetchList();
    }else{
      document.getElementById('msg').textContent = 'Delete failed: ' + (j.error || res.statusText);
    }
  }catch(err){
    document.getElementById('msg').textContent = 'Delete failed (check console)';
    console.error(err);
  }
}

// Initial load
fetchList();
</script>

<!-- Inject cloud name safely -->
<script>
  window.CLOUDINARY_CLOUD_NAME = "{{CLOUDINARY_CLOUD_NAME}}";
</script>

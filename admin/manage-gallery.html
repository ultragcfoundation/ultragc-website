<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Manage Gallery — UltraGC Admin</title>
<style>
  body{font-family:Arial, sans-serif;background:#f7f6f3;margin:0}
  header{background:#fff;padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .brand{font-weight:700;color:#c1973d}
  main{max-width:1100px;margin:24px auto;padding:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .card img,.card video{width:100%;height:150px;object-fit:cover;border-radius:8px}
  .input, select{width:100%;padding:8px;margin-top:8px;border-radius:6px;border:1px solid #ddd}
  .btn{margin-top:8px;padding:10px;border-radius:8px;border:none;background:#c1973d;color:#000;font-weight:700;cursor:pointer;width:100%}
  .del{background:#b30000;color:#fff}
  .muted{color:#666;margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="brand">UltraGC Admin — Manage Gallery</div>
  <div>
    <button onclick="location.href='dashboard.html'" style="margin-right:8px;padding:8px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">Back</button>
    <button onclick="location.href='upload-gallery.html'" style="padding:8px;border-radius:8px;border:none;background:#c1973d;cursor:pointer;font-weight:700">Upload</button>
  </div>
</header>

<main>
  <h2 style="color:#c1973d;margin:0 0 6px">Gallery Items</h2>
  <p class="muted">Items listed here are those uploaded with tag <strong>ultragc_gallery</strong>.</p>

  <div id="grid" class="grid"></div>
  <div id="msg" style="margin-top:12px;font-weight:700;color:#333"></div>
</main>

<script>
const cloudName = "dfqdlwwef";
const listTag = "ultragc_gallery"; // tag we used in uploads

async function fetchList(){
  // Cloudinary public "list by tag" JSON endpoint:
  // https://res.cloudinary.com/<cloud_name>/image/list/<tag>.json
  const url = `https://res.cloudinary.com/${cloudName}/image/list/${listTag}.json?_=${Date.now()}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('No list or Cloudinary blocked the request');
    const data = await res.json();
    renderGrid(data.resources || []);
  }catch(err){
    document.getElementById('msg').textContent = 'Unable to load gallery list. Upload some items or check tag.';
    console.error(err);
  }
}

function renderGrid(resources){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  if(!resources.length){ grid.innerHTML = '<p>No items found.</p>'; return; }

  resources.forEach(r => {
    // Build public URL (auto-detect image vs video)
    const base = `https://res.cloudinary.com/${cloudName}/`;
    const isVideo = (r.format==='mp4' || r.format==='webm');
    const url = `${base}${isVideo ? 'video' : 'image'}/upload/${r.public_id}.${r.format}`;

    const caption = (r.context && r.context.custom && r.context.custom.caption) ? r.context.custom.caption : '';
    const category = (r.context && r.context.custom && r.context.custom.category) ? r.context.custom.category : '';

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      ${isVideo ? `<video src="${url}" controls></video>` : `<img src="${url}">`}
      <div style="margin-top:8px;font-weight:700">${escapeHtml(caption)}</div>
      <div class="muted">${escapeHtml(category)}</div>

      <label style="margin-top:8px;font-weight:700">Edit caption</label>
      <input class="input" data-id="${r.public_id}" value="${escapeHtmlAttr(caption)}" type="text" />

      <label style="margin-top:8px;font-weight:700">Change category</label>
      <select class="input" data-id-cat="${r.public_id}">
        <option value="">-- select --</option>
        <option value="outreach"${category==='outreach'?' selected':''}>Outreach</option>
        <option value="widows"${category==='widows'?' selected':''}>Widows</option>
        <option value="orphans"${category==='orphans'?' selected':''}>Orphans</option>
        <option value="events"${category==='events'?' selected':''}>Events</option>
        <option value="scholarships"${category==='scholarships'?' selected':''}>Scholarships</option>
      </select>

      <button class="btn" data-save="${r.public_id}">Save</button>
      <button class="btn del" data-del="${r.public_id}">Delete</button>
    `;
    grid.appendChild(card);
  });

  // attach events
  document.querySelectorAll('[data-save]').forEach(btn=> btn.onclick = saveHandler);
  document.querySelectorAll('[data-del]').forEach(btn=> btn.onclick = delHandler);
}

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeHtmlAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }

async function saveHandler(e){
  const id = e.currentTarget.getAttribute('data-save');
  const captionInput = document.querySelector(`input[data-id="${id}"]`);
  const categorySelect = document.querySelector(`select[data-id-cat="${id}"]`);
  const caption = captionInput.value.trim();
  const category = categorySelect.value;

  // Call server-side function to update resource metadata (server function required)
  // POST /.netlify/functions/update-metadata  { public_id, caption, category }
  document.getElementById('msg').textContent = 'Saving...';
  try{
    const res = await fetch('/.netlify/functions/update-metadata', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ public_id: id, caption, category })
    });
    const j = await res.json();
    if(res.ok) {
      document.getElementById('msg').textContent = 'Saved successfully';
      fetchList(); // refresh
    } else {
      document.getElementById('msg').textContent = 'Save failed: ' + (j.error || res.statusText);
    }
  }catch(err){
    document.getElementById('msg').textContent = 'Save failed (check console)';
    console.error(err);
  }
}

async function delHandler(e){
  const id = e.currentTarget.getAttribute('data-del');
  if(!confirm('Delete this file?')) return;
  document.getElementById('msg').textContent = 'Deleting...';
  try{
    const res = await fetch('/.netlify/functions/delete-resource', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ public_id: id })
    });
    const j = await res.json();
    if(res.ok){
      document.getElementById('msg').textContent = 'Deleted';
      fetchList();
    } else {
      document.getElementById('msg').textContent = 'Delete failed: ' + (j.error || res.statusText);
    }
  }catch(err){
    document.getElementById('msg').textContent = 'Delete failed (check console)';
    console.error(err);
  }
}

// initial load
fetchList();
</script>
</body>
</html>

<script>
const cloudName = window.CLOUDINARY_CLOUD_NAME;
const uploadPreset = "unsigned_preset";
const folderName = "ultragc_gallery";

const fileInput = document.getElementById('file');
const preview = document.getElementById('preview');
const uploadBtn = document.getElementById('uploadBtn');
const msg = document.getElementById('msg');
const bar = document.getElementById('bar');
const progressWrap = document.getElementById('progress');

fileInput.addEventListener('change', () => {
  const f = fileInput.files[0];
  if(!f) { preview.innerHTML=''; return; }
  preview.innerHTML = f.type.startsWith('image') ? `<img src="${URL.createObjectURL(f)}">` : `<video src="${URL.createObjectURL(f)}" controls></video>`;
});

uploadBtn.addEventListener('click', () => {
  const f = fileInput.files[0];
  const caption = document.getElementById('caption').value.trim();
  const category = document.getElementById('category').value;
  if(!f || !caption || !category){ msg.textContent = "Please provide file, caption and category."; return; }

  uploadBtn.disabled = true;
  msg.textContent = "Uploading...";
  progressWrap.style.display = 'block';

  const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
  const form = new FormData();
  form.append('file', f);
  form.append('upload_preset', uploadPreset);
  form.append('folder', folderName);
  form.append('tags', folderName);
  form.append('context', `caption=${caption}|category=${category}`);

  const xhr = new XMLHttpRequest();
  xhr.open('POST', url);
  xhr.upload.addEventListener('progress', (e) => {
    if(e.lengthComputable){
      const p = Math.round((e.loaded / e.total) * 100);
      bar.style.width = p + '%';
    }
  });
  xhr.onload = () => {
    uploadBtn.disabled = false;
    if(xhr.status === 200){
      msg.textContent = "Upload successful â€” it will appear in the gallery shortly.";
      fileInput.value = "";
      preview.innerHTML = "";
      bar.style.width = "0%";
      progressWrap.style.display = 'none';
      setTimeout(()=> location.href = 'manage-gallery.html', 900);
    } else {
      msg.textContent = "Upload failed. See console.";
      console.error(xhr.responseText);
    }
  };
  xhr.onerror = () => {
    uploadBtn.disabled = false;
    msg.textContent='Upload error.';
  };
  xhr.send(form);
});
</script>

<!-- Inject cloud name from Netlify environment variable -->
<script>
  window.CLOUDINARY_CLOUD_NAME = "{{CLOUDINARY_CLOUD_NAME}}";
</script>
